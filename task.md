# Linga 英语学习应用 (Windows) - 任务列表

- [ ] 项目初始化
    - [x] 创建初始规划文档
    - [x] 使用 Vite + React + Electron 初始化项目
    - [x] 设置基本文件夹结构
    - [ ] 配置 ESLint/Prettier
    - [x] UI/UX 重构 (基于新设计图)
        - [x] 安装图标库 `lucide-react`
        - [x] **[NEW]** 实现主布局容器 (MainLayout) 与背景样式
        - [x] **[NEW]** 实现底部导航栏 (词典, 首页, 图书馆, 锻炼, 个人资料)
        - [x] 调整标签顺序 (书库在词典左侧)
        - [x] 配置 React Router 路由结构
    - [/] **[NEW]** 测试与质量保证 (Testing & QA)
        - [x] 配置 Vitest & React Testing Library 环境
        - [x] 编写核心服务单元测试 (Services)
            - [x] WordStore (CRUD)
            - [x] HybridDictionaryService (聚合逻辑)
            - [x] TranslationService (Provider 切换)
        - [x] 编写关键组件集成测试
        - [x] 建立手动冒烟测试清单 (参考 verify_tests.md)

- [ ] 核心功能: 词典与统计 (Dictionary)
    - [/] **[NEW]** 构建混合词典服务 (Hybrid Dictionary Service)
        - [x] **ECDICT 集成**: 导入 ECDICT (简明英汉) 数据库 (SQLite/CSV) 到本地
        - [x] **Online API**: 集成 Free Dictionary API (获取英英释义/音频)
        - [x] **音频缓存系统**: 实现发音文件的自动下载与本地持久化 (Cache)
        - [x] **聚合逻辑**: 实现查询分发 (本地优先 -> 在线补充 -> AI 兜底)
    - [/] **性能优化 (Performance)**:
        - [x] 异步加载音频，避免阻塞 UI
        - [ ] **[NEW]** 优化查词响应速度 (UI 优先策略)
            - [x] **阅读器即时弹窗**: 移除 Reader 中的阻塞式翻译等待，点击后立即打开弹窗，将翻译任务移至弹窗内部异步执行
            - [x] **渐进式数据加载**: 优化 `hybridDictionary.query` 逻辑，优先返回并显示本地结果 (ECDICT 中文释义)，随后后台加载 Free Dictionary API (英英/音频) 并更新 UI
    - [x] **[NEW]** UI/UX 交互优化 (查词体验) - **方案 C: 无遮罩浮窗**
        - [x] **移除模态遮罩**: 修改 `WordDetailPopup`，移除全屏黑色背景 (`bg-black bg-opacity-30`)，允许用户看到背后的文本
        - [x] **实现点击外部关闭**: 添加点击监听 (Click Outside)，在点击弹窗外部区域时自动关闭详情页
        - [x] **样式增强**: 增加弹窗的阴影 (`shadow-2xl`) 和边框，确保在复杂背景下的视觉辨识度
        - [x] **[NEW]** 数据溯源开关 (Source Visibility Toggle):
            - [x] **来源切换按钮**: 在弹窗头部（如单词旁或右上角）增加一个 "Info/Source" 样式的切换图标 (默认为关闭状态)
            - [x] **细粒度来源标签**: 当开关开启时，在单词原型、中文释义、英文释义、音标、音频播放器旁边分别显示微型标签 (Badges)，明确标识其来源 (如 "Local", "Online", "AI")
        - [x] **[NEW]** 优化上下文提取 (Context Extraction):
            - [x] **精准截取单句 (Sentence Only)**: 在 `Reader.tsx` 中，通过正则 (Regex) 匹配句号、问号、感叹号等结束符，**仅截取并显示包含选中单词的那一个完整句子**，严格过滤掉段落中的其他内容。
    - [/] **[NEW]** 词典主页 UI 还原 (严格参考 image_acde20)
        - [x] 顶部 Tabs (我的单词 / 群组)
        - [x] "所有单词" 跳转条组件
        - [x] 统计与图表综合卡片 (包含时间过滤器)
        - [x] 统计数据展示 (蓝色"新单词"卡片 + 进行中/已学习状态)
        - [x] 底部悬浮 "添加单词" 按钮 (FAB)
    - [/] **[NEW]** 群组功能开发 (Word Groups / Vocabulary Collections)
        - [x] **群组列表 UI** (Groups Tab)
            - [x] 显示所有群组卡片 (名称、单词数量、创建时间)
            - [x] 群组卡片样式 (参考截图: 左侧群组名+时间, 右侧单词数)
            - [x] 空状态提示 (无群组时显示引导)
            - [x] "创建群组" FAB 按钮
        - [x] **群组 CRUD 操作**
            - [x] 创建群组对话框 (名称输入, 可选描述)
            - [x] 编辑群组信息 (重命名、修改描述)
            - [x] 删除群组确认 (带单词数量提示)
        - [x] **群组详情页**
            - [x] 显示群组内单词列表
            - [x] 支持移除单词 (从群组中移除, 不删除单词本身)
            - [x] 群组内搜索单词 (搜索功能按钮)
            - [x] 进入群组专属练习
        - [/] **添加单词到群组**
            - [x] **搜索添加**: 在群组详情页搜索字典并添加单词
            - [ ] **多选添加**: 从"全部单词"页面多选后添加到群组
            - [ ] **上传添加**: 支持导入单词列表 (CSV/TXT 格式)
        - [x] **群组练习入口**
            - [x] 从群组详情页启动练习 (限定范围为该群组单词)
    - [x] **[NEW]** 实现单词详情/查询弹窗 (Popup)
        - [x] **重构**: 从单纯显示 WordStore 数据升级为支持 HybridDictionaryResult
        - [x] **单词详情页 UI 重构 (New Design)**
            - [x] **设计规范**:
                - [x] **布局结构**: 采用 Card-based (卡片式) 布局，利用圆角 (rounded-2xl) 和阴影 (shadow-2xl) 营造层次感。头部固定（单词、音标、发音、全局来源切换），底部固定（操作按钮）。
                - [x] **内容板块 (DetailSection)**: 统一采用 左侧装饰线 + 标题栏 + 内容区 的结构。标题栏高度固定 (h-6)，包含图标、标题名称和可选的来源标签 (Badge)。来源标签设计紧凑，不影响高度。支持折叠交互。
                - [x] **信息展示顺序**:
                    - [x] 中文释义 (默认展开，绿色系 bg-green-500)
                    - [x] 英文释义 (默认折叠，紫色系 bg-purple-500)
                    - [x] 原句 (默认折叠，蓝色系 bg-blue-500)
                    - [x] AI 深度解析 (默认折叠，琥珀色系 bg-amber-500)
                - [x] **间距与排版**: 内容区域垂直间距紧凑 (space-y-5)，字体清晰分层。
        - [x] **核心头部**: 显示单词原型, 音标, 词性, 频率标签
        - [x] **音频功能**: 优先播放本地缓存, 无缓存则联网播放并保存
        - [x] **基本释义**: 显示 ECDICT 中文解释
        - [x] **折叠内容区**:
            - [x] **句子**: 显示查询时的上下文原句/例句
            - [x] AI 模块: 调用 Ollama 进行 AI 翻译与词源解释 (UI 已实现, AI 功能待完善)
            - [x] 扩展信息: 定义, 示例 (Free Dictionary API)
        - [x] **底部操作**: "+ 到字典" / "移除" 状态切换按钮
        - [x] **搜索功能**: 支持从 FAB 按钮打开时输入单词搜索
    - [ ] 单词列表展示页 (点击"所有单词"后的页面)
    - [ ] **[NEW]** 外部词典扩展 (Low Priority / 后期开发)
        - [ ] 研究 .mdx (Mdict) 文件格式解析
        - [ ] 实现 .mdx 词典文件导入与查询解析

- [ ] 核心功能: 书库与阅读器 (Library)
    - [x] 添加 EPUB 解析库 (如 epub.js)
    - [x] 文件导入功能 (解析元数据：封面、标题)
    - [x] **[NEW]** 图书持久化存储 (IndexedDB/Electron-store)
        - [x] 实现保存已导入图书的路径和元数据
        - [x] 启动时加载图书列表
    - [x] **[NEW]** 书库管理 UI
        - [x] 网格视图显示图书封面
        - [x] 实现 "删除图书" 功能
    - [x] 阅读器核心功能 (翻页、进度)
    - [x] 阅读器交互 (点击查词 -> 触发上述单词详情弹窗)

- [/] 核心功能: 锻炼 (Exercise)
    - [x] **[NEW]** 实现锻炼页 "混合练习" 顶部大卡片
    - [x] **[NEW]** 实现练习模式列表 (闪卡, 多项选择等)
    - [/] **[NEW]** 锻炼页面统计 (Exercise Statistics) [参考词典页]
        - [/] **统计概览卡片**: 实现类似词典页的统计卡片 (如: 今日复习数, 累计学习时长, 记忆曲线状态)
        - [/] **可视化图表**: 增加学习趋势图/热力图，展示每日复习活跃度
    - [x] **[NEW]** SRS 核心逻辑 (Spaced Repetition System)
        - [x] **WordStore 升级**: 添加 lastReviewedAt, reviewCount, easeFactor, interval 字段
        - [x] **复习算法**: 实现 SM-2 简易版算法 (submitReview)
        - [x] **获取待复习**: 实现 getDueWords 方法
    - [x] **[NEW]** 训练设置功能 (Exercise Settings)
        - [x] **设置组件**: 实现 `ExerciseSettings.tsx` 全屏设置页面
        - [x] **通用设置**: 显示训练设置开关、选择训练单词数量(1-50)、复杂拼写训练开关
        - [x] **发音设置**: 自动播放发音、播放速度滑块
        - [x] **混合训练组成**: 可选择启用/禁用6种练习模式(闪卡、多选、拼写、听力选择、听力拼写、选词填空)
        - [x] **设置按钮**: 在ExerciseHub、ExerciseSession等页面头部添加设置入口
        - [x] **保存功能**: 顶部"取消/保存"按钮 + 底部保存按钮，设置持久化到localStorage
    - [x] **[NEW]** 准备好学习了功能 (Ready to Learn)
        - [x] **显示逻辑**: 显示状态为'new'的未学习单词数量
        - [x] **点击行为**: 直接开始混合练习，只选择未学习过的单词
        - [x] **单词数量限制**: 使用设置中的wordCount限制练习单词数
    - [x] **[NEW]** 混合训练模式组合 (Mixed Training Composition)
        - [x] **多模式学习**: 每个单词用设置中所有启用的模式各学一遍
        - [x] **练习项生成**: 根据 单词数 × 启用模式数 生成练习项列表
        - [x] **进度显示**: 显示当前练习项索引/总练习项数
    - [x] **[NEW]** 训练完成批量保存 (Batch Save on Complete)
        - [x] **暂存结果**: 答题结果先暂存到pendingResults，不立即提交
        - [x] **批量提交**: 只有完成全部练习项后才一次性保存所有单词状态
        - [x] **中途退出**: 退出时不保存任何进度，单词状态保持不变
    - [/] **[Refactor]** 练习模式体验优化 (Exercise UX & Logic)
        - [x] 会话容器 (ExerciseSession.tsx) - 基础实现
        - [x] **[NEW]** 练习前置流程 (Scope Selection):
            - [x] 实现 "学习范围选择" 界面 (ExerciseScopeSelector.tsx)
            - [x] 支持选项: 今天添加的单词, 随机词汇, 随机新词, 随机学习单词
            - [x] 支持选择群组 (我的小组) 进行专项练习
        - [x] **单词构建重构 (Construction Mode)**:
            - [x] 将 "拼写模式" (Spelling) 重构为 "单词构建" (Word Construction)
            - [x] 实现逻辑: 显示中文释义 -> 提供打乱的字母块 -> 用户点击/拖拽完成拼写
            - [x] 实现新视觉设计: Tailwind 配色方案 (bg-white, text-slate-900, blue-600主色)
            - [x] 实现布局: Header(进度条+计数), Context(功能按钮+释义), Slots(填空区), Keyboard(字母池), Footer(成功按钮)
            - [x] 实现点击即校验逻辑: 对→填入&隐形，错→颤动，完→显下一步
            - [x] 仅显示中文释义: 移除音标和英文显示，参考提示只保留中文解释
            - [x] 使用单词原型: 使用 lemma (原型) 而非变形词进行拼写测试 (如 look 而非 looking)
            - [x] 自动填入逻辑: 点击字母自动填入下一个空槽位，无需先点击输入框
            - [x] 语音播放按钮: 添加醒目的圆形音频播放按钮 (蓝色大按钮)
    - [x] 练习逻辑: 混合模式

- [ ] 核心功能: 我的单词页面 (Word List)
    - [x] **[NEW]** 单词列表页面 (WordList.tsx)
        - [x] **状态筛选标签**: 新的/学习/已学习 (移除全部，默认选中新的)
        - [x] **排序下拉菜单**: 字母顺序、进度、最后训练、下一次训练、重复次数、添加时间、频率
        - [x] **升降序切换**: 点击切换升序/降序排列
        - [x] **单词总数显示**: 显示筛选后的单词数量
        - [x] **筛选逻辑修复**: 学习标签显示learning+reviewed状态单词
    - [x] **[NEW]** 词典统计修复
        - [x] "新的"卡片改为显示statusCounts.new (未开始学习的单词)
        - [x] 副标签改为"未开始学习"

- [ ] 数据与设置
    - [ ] 设置 SQLite/Store 数据库 (用于单词和图书记录)
    - [x] **[NEW]** 设置页面 UI 开发
        - [x] 实现 Ollama 配置模块 (服务器地址, 模型 ID, 自定义提示词)
        - [x] 配置持久化存储 (保存用户设置)
        - [x] 连接测试功能 (验证 Ollama 是否在线)
    - [/] 多源翻译支持 (Google API, DeepSeek, **Ollama**)
    - [ ] 生词状态管理 (New -> Learning -> Review)
    - [ ] 个人资料页 UI

- [x]  SRS 评分逻辑重构 (Weighted Aggregation Strategy)
        - [x] **定义模式权重 (Mode Weights)**: 在 `ExerciseSession` 中配置权重常量 `MODE_WEIGHTS`
            - [x] 主动输出型 (高权重): 拼写 (2.0), 听力拼写 (2.0), 选词填空 (1.5)
            - [x] 被动识别型 (标准权重): 闪卡 (1.0), 听力选择 (1.0), 多项选择 (0.8)
        - [x] **实现综合评分算法**: 开发 `calculateWeightedScore` 工具函数
            - [x] **一票否决机制 (Veto Power)**: 若任意模式评分为 0 (完全忘记)，最终评分直接判为 0
            - [x] **严重错误惩罚**: 若任意模式评分为 1 (错误)，最终评分强制判为 1 (或高权重惩罚)
            - [x] **加权平均计算**: 基于 `(评分 × 权重) / 总权重` 计算最终 Quality (四舍五入)
        - [x] **重构提交逻辑 (Submit Once)**: 修改 `handleResult` 的结算流程
            - [x] **结果聚合**: 练习过程中仅暂存结果 (包含 `mode` 和 `quality`)，不调用 API
            - [x] **按单词分组**: 结算时将同一单词的不同模式结果归类
            - [x] **统一提交**: 循环调用 `calculateWeightedScore` 得出最终分，每个单词仅触发一次 `WordStore.submitReview`
            
- [x] SRS 算法验证与日志系统 (Verification)
    - [x] **后端日志服务**: 在 `electron/main.ts` 实现 `debug:log-srs` 接口，支持将 JSON 数据追加写入桌面文件
    - [x] **暴露接口**: 在 `preload.ts` 中暴露 `logSRS` 方法
    - [ ] **前端数据采集**: 在 `ExerciseSession` 结算流程中植入探针
        - [ ] 捕获原始输入 (Mode Scores & Weights)
        - [ ] 捕获 SRS 变更前状态 (Before State)
        - [ ] 捕获 SRS 变更后状态 (After State - via Refetch)
        - [ ] 生成完整差异报告并调用日志接口
    - [ ] **执行验证测试**:
        - [ ] 运行一次混合练习，包含“全部掌握”、“部分错误”、“完全忘记”三种情况
        - [ ] 检查桌面 `linga_srs_debug.json`
        - [ ] 确认 Interval 和 EF 值的变化符合 SM-2 算法预期
    - [ ] 在我的-设置界面添加开关，是否启用这个功能
- [ ] 修复复习模式筛选逻辑 (Review Mode Logic)
        - [ ] **问题描述**: 当前 `ExerciseSession` 的 `loadSession` 方法缺少针对 "review" (复习) scope 的处理分支，导致点击“开始复习”时错误地加载了所有“学习中”的单词，而非仅加载“到期”单词。
        - [ ] **修改代码**: 在 `src/pages/Exercise/ExerciseSession.tsx` 的 `switch(scope)` 语句中添加 `case 'review'`。
        - [ ] **实现逻辑**: 调用 `await WordStore.getDueWords()` 仅获取 `nextReviewAt <= now` 的单词。
- [ ] 优化 SRS 间隔时间计算 (SRS Timing Alignment)
    - [ ] **问题描述**: 当前算法基于 `Date.now()` 精确计算复习时间。例如今晚 23:00 复习的单词，必须等到明晚 23:00 才能复习，体验不佳。
    - [ ] **优化目标**: 采用“自然日”结算机制 (Day-based alignment)。
    - [ ] **实现逻辑**: 修改 `src/services/WordStore.ts` 中的 `submitReview` 方法。
        - [ ] 计算 `nextReviewAt` 时，不直接使用 `now + interval`。
        - [ ] 将时间标准化为 **目标日期的凌晨 04:00** (Day Start Threshold)。这样只要跨过凌晨4点，所有当天的复习任务都会激活，无需等待具体时刻。